---
title: "Format COVID Resources "
output: html_notebook
---

```{r}
library(tidyverse)
library(config)
library(ggmap)
```



# Purpose

The purpose of this notebook to format the data received from the Community Alignment Specialist for use with the COVID Agency finder shiny app. 


## Import Data

Import the data exactly as it was from the google sheet.

```{r}
resources <- read_csv("resources.csv")
```


## Data cleaning

Rename columns so there are no hypens or spaces! You will thank me later!

```{r}
resources <- rename(resources,
                     Program = 'Program Name',
                     lastUpdated = 'Last Updated',
                     Mon = 'Mon-Hours',
                     Tue = 'Tues-Hours',
                     Wed = 'Wed-Hours',
                     Thu = 'Thur-Hours',
                     Fri = 'Fri-Hours',
                     Sat = 'Sat-Hours',
                     Sun = 'Sun-Hours',
                     Address1 = 'Street Address',
                     Address2 = 'Addressline 2',
                     Description = 'Program Description')
```




Always need to clean your data. Check to see if there are blank rows that might have been used to improve readibility but serve no function in a database.

```{r}
#drop rows in df resources where column 'Organization' is NA
resources <-drop_na(resources, Organization)
```


Program column can not be left blank. If there is a NA in that column replace NA with the value for the Organization Column.

```{r}

resources$Program <- if_else(is.na(resources$Program), #test condition 
                              resources$Organization,   #value if test TRUE
                              resources$Program)       #value if test FALSE  


```



Replace NA's from operating hours. If column is NA, then replace it with 'Closed'.


```{r}
resources <- replace_na(resources,
                         list(Mon = "Closed", 
                              Tue ="Closed",
                              Wed = "Closed",
                              Thu = "Closed",
                              Fri = "Closed",
                              Sat = "Closed",
                              Sun = "Closed",
                              County = "Guilford"
                              )
) 
```


Spot check the number of unique organizations


```{r}
unique(resources[,"Organization"])
```


## Geocode Addresses

Create single address line to pass to Google API

```{r}
resources <-mutate(resources,
                   AddressLine = str_c(Address1, " ", City,", ", "NC" , sep = "" ))
```


Set API keys for google Geocode

```{r}
config <- config::get()

register_google(key =config$googKey )
```




```{r}
# Loop through the addresses to get the latitude and longitude of each address and add it to the
# origAddress data frame in new columns lat and lon
for(i in 1:nrow(resources))
{
  # Print("Working...")
  result <- geocode(resources$AddressLine[i], output = "latlona", source = "google", )
  resources$lon[i] <- as.numeric(result[1])
  resources$lat[i] <- as.numeric(result[2])
  resources$geoAddress[i] <- as.character(result[3])
}
```



Save file for use with Finder.

```{r}
write.csv(resources, file = "resourcesGeocoded.csv", row.names = FALSE )
```





